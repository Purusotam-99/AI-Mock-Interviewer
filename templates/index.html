<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Mock Interviewer Pro</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --primary-grad: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --glass-bg: rgba(255, 255, 255, 0.1);
      --glass-border: 1px solid rgba(255, 255, 255, 0.2);
      --text-color: #ffffff;
      --bubble-user: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
      --bubble-bot: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    body.light {
      --primary-grad: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      --glass-bg: rgba(0, 0, 0, 0.05);
      --glass-border: 1px solid rgba(0, 0, 0, 0.1);
      --text-color: #333333;
    }

    * { box-sizing: border-box; transition: all 0.3s ease; }

    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: #0f2027; 
      background: linear-gradient(to right, #2c5364, #203a43, #0f2027); 
      color: var(--text-color);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    body.light { background: #e0eafc; }

    .app-container {
      width: 100%;
      max-width: 1100px;
      background: var(--glass-bg);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-radius: 24px;
      border: var(--glass-border);
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
      padding: 30px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    /* --- MOBILE WARNING STYLES --- */
    #mobile-warning { display: none; }

    /* ‚úÖ USE THIS NEW BLOCK */
@media screen and (max-width: 1024px) {
    /* 1. Hide the warning forever */
    #mobile-warning { display: none !important; }

    /* 2. Make the app show up and fit the screen */
    .app-container {
        display: flex !important;
        width: 100% !important;
        padding: 15px; /* Add breathing room */
        margin: 0;
        border-radius: 0; /* Full screen look */
        min-height: 100vh;
    }

    /* 3. Stack the dashboard cards vertically */
    .dashboard-grid {
        grid-template-columns: 1fr !important;
    }
    
    /* 4. Make the chart fit */
    .card[style*="grid-column: span 2"] {
        grid-column: span 1 !important;
    }
}

    /* --- HEADER --- */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      border-bottom: var(--glass-border);
      padding-bottom: 20px;
    }

    .title-group { display: flex; align-items: center; gap: 10px; }
    .logo-icon { font-size: 2rem; }
    h1 { margin: 0; font-weight: 700; font-size: 1.8rem; letter-spacing: 0.5px; line-height: 1; }
    .pro-badge { font-size: 0.5em; font-weight: 700; text-transform: uppercase; opacity: 0.6; margin-left: 5px; vertical-align: middle; color: inherit; }

    .controls { display: flex; gap: 10px; }

    select {
      background: rgba(0, 0, 0, 0.3);
      color: white;
      border: 1px solid rgba(255,255,255,0.2);
      padding: 10px 15px;
      border-radius: 12px;
      outline: none;
      font-family: inherit;
      cursor: pointer;
    }
    body.light select { background: white; color: #333; border: 1px solid #ccc; }

    /* --- TIMER --- */
    #timer {
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      font-size: 1.1rem;
      padding: 8px 16px;
      background: var(--glass-bg);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: var(--glass-border);
      border-radius: 12px;
      transition: all 0.3s ease;
    }

    /* --- CHAT BOX --- */
    #chat-box {
      flex: 1;
      height: 400px;
      overflow-y: auto;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 20px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .message {
      max-width: 80%;
      padding: 12px 18px;
      border-radius: 18px;
      line-height: 1.5;
      position: relative;
      animation: fadeIn 0.4s ease;
      font-size: 0.95rem;
    }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .message.bot {
      background: var(--bubble-bot);
      color: #004e92;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
      font-weight: 500;
    }

    .message.user {
      background: var(--bubble-user);
      color: #0f3443;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
      font-weight: 500;
    }

    /* --- DIFFICULTY BADGES --- */
    .diff-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        margin-bottom: 5px;
        letter-spacing: 0.5px;
    }
    .diff-easy { background: rgba(67, 233, 123, 0.2); color: #006400; border: 1px solid #006400; }
    .diff-medium { background: rgba(255, 206, 86, 0.2); color: #8B4500; border: 1px solid #8B4500; }
    .diff-hard { background: rgba(255, 94, 98, 0.2); color: #8B0000; border: 1px solid #8B0000; }
    .diff-practical { background: rgba(54, 209, 220, 0.2); color: #005f6b; border: 1px solid #005f6b; }
    
    body:not(.light) .diff-easy { color: #ccffcc; border-color: #ccffcc; }
    body:not(.light) .diff-medium { color: #ffeebb; border-color: #ffeebb; }
    body:not(.light) .diff-hard { color: #ffcccc; border-color: #ffcccc; }
    body:not(.light) .diff-practical { color: #ccffff; border-color: #ccffff; }


    /* --- ACTION BAR --- */
    .action-bar {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-top: 10px;
    }

    button {
      padding: 12px 24px;
      border: none;
      border-radius: 14px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 0.85rem;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .btn-start { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .btn-speak { background: linear-gradient(135deg, #ff9966 0%, #ff5e62 100%); color: white; }
    .btn-end { background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); color: white; }
    .btn-theme { background: rgba(255,255,255,0.1); color: inherit; border: 1px solid rgba(255,255,255,0.2); }

    button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
    button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    #status { font-size: 0.9rem; opacity: 0.7; margin-left: auto; font-style: italic; }

    /* --- DASHBOARD --- */
    #dashboard {
      display: none;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 24px;
      padding: 25px;
      margin-top: 20px;
      animation: fadeIn 0.6s ease;
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 25px;
    }

    .card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      padding: 20px;
      border: 1px solid rgba(255,255,255,0.05);
    }

    h3, h4 { margin: 0 0 15px 0; font-weight: 600; }

    /* --- UPDATED HEATMAP STYLES (Matches Screenshot) --- */
    .heatmap-container { display: flex; flex-wrap: wrap; gap: 10px; }
    .tag {
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 600;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    /* Strong = Green Background with Bright Text */
    .tag.strong { 
        background: rgba(39, 174, 96, 0.25); 
        color: #2ecc71; 
        border: 1px solid #2ecc71; 
    }
    /* Weak = Red Background with Bright Text */
    .tag.weak { 
        background: rgba(231, 76, 60, 0.25); 
        color: #e74c3c; 
        border: 1px solid #e74c3c; 
    }

    /* --- NEW LOADER STYLES (Matches "Processing" Screenshot) --- */
    .loader-pill {
        background: rgba(0, 0, 0, 0.6); 
        border-radius: 50px;             
        padding: 10px 20px;
        margin-bottom: 10px;
        color: #eee;
        font-family: 'Poppins', sans-serif; 
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 10px;
        width: fit-content;
        border: 1px solid rgba(255,255,255,0.1);
        animation: slideIn 0.4s ease;
    }
    @keyframes slideIn { from { opacity:0; transform:translateX(-10px); } to { opacity:1; transform:translateX(0); } }

    /* The Pink Gear Icon */
    .loader-icon { color: #ff9a9e; animation: spin 2s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    /* The Green Checkmark */
    .loader-check { color: #2ecc71; font-weight: bold; }

    .missed-box {
      margin-top: 15px;
      padding: 15px;
      background: rgba(255, 94, 98, 0.1);
      border-radius: 12px;
      border-left: 4px solid #ff5e62;
      font-size: 0.9rem;
      color: #ffcccb;
    }

    .prob-badge {
      font-size: 2rem;
      font-weight: 700;
      background: linear-gradient(to right, #43e97b, #38f9d7);
      -webkit-background-clip: text;
      background-clip: text; 
      -webkit-text-fill-color: transparent;
      color: transparent;
    }

    @media (max-width: 768px) {
      .dashboard-grid { grid-template-columns: 1fr; }
      .controls { width: 100%; justify-content: space-between; margin-top: 10px; }
      select { width: 48%; }
      .card[style*="grid-column: span 2"] { grid-column: span 1 !important; }
    }
    /* Processing Pulse Animation */
@keyframes pulse {
  0% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.1); opacity: 0.8; }
  100% { transform: scale(1); opacity: 1; }
}

.processing-icon {
  display: inline-block;
  animation: pulse 1.5s infinite ease-in-out;
  font-size: 1.2rem;
  margin-right: 10px;
}

.processing-box {
  background: rgba(0, 0, 0, 0.4);
  border: 1px solid rgba(255, 255, 255, 0.1);
  color: #fff;
  padding: 15px 20px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  font-family: 'Poppins', sans-serif;
  margin-top: 10px;
}
  </style>
</head>
<body>

  <div id="mobile-warning">
    <div class="icon">üíª</div>
    <h2>Desktop Experience Required</h2>
    <p>
      <strong>AI Interviewer Pro</strong> is optimized for Laptop/PC screens.
      <br><br>
      Please switch to <strong>"Desktop Site"</strong> mode in your browser settings to continue.
    </p>
  </div>

  <div class="app-container">
    <header>
      <div class="title-group">
          <div class="logo-icon">üéôÔ∏è</div>
          <h1>AI Interviewer<span class="pro-badge">PRO</span></h1>
      </div>

      <div class="controls">
        <select id="lengthSelect">
          <option value="5">‚ö° Quick (5)</option>
          <option value="8" selected>üéØ Standard (8)</option>
          <option value="12">üî• Deep (12)</option>
        </select>
        <select id="topicSelect">
          <option value="javascript">JavaScript</option>
          <option value="dsa">DSA</option>
          <option value="sql">SQL</option>
          <option value="python">Python</option>
        </select>
        <button id="login-btn" onclick="handleLogin()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 8px 15px; border-radius: 12px; cursor: pointer; font-family:inherit;">
  Login
</button>

<div id="user-profile" style="display:none; align-items:center; gap:8px; background:rgba(255,255,255,0.1); padding:5px 10px; border-radius:20px;">
   <img id="user-img" src="" style="width:24px; height:24px; border-radius:50%;">
   <span id="user-name" style="font-size:0.8rem; font-weight:600;"></span>
   <small onclick="handleLogout()" style="cursor:pointer; opacity:0.7; font-size:0.7rem;">(‚úñ)</small>
</div>
      </div>
    </header>

    <div class="action-bar" style="margin-bottom:10px; justify-content: space-between;">
        <button class="btn-theme" onclick="toggleTheme()">üåì Theme</button>
        <div id="timer">‚è± 00:00</div>
    </div>

    <div id="chat-box">
      <div style="text-align:center; color:rgba(255,255,255,0.5); margin-top:150px;">
        Select a topic and length above,<br>then click <strong>Start Interview</strong>.
      </div>
    </div>

    <div class="action-bar">
      <button class="btn-start" onclick="startInterview()">Start Interview</button>
      <button class="btn-speak" onclick="startListening()">üéô Speak Answer</button>
      <button class="btn-end" onclick="endInterview()">End & Analyze</button>
      <span id="status">Ready</span>
    </div>

    <div id="dashboard">
      <div class="dashboard-header">
        <div>
          <h3>Interview Analysis</h3>
          <span style="opacity:0.7">Performance Report</span>
        </div>
        <div style="text-align:right;">
          <div style="font-size:0.8rem; opacity:0.7;">Hiring Probability</div>
          <div class="prob-badge" id="hiringProb">0%</div>
        </div>
      </div>

      <div class="dashboard-grid">
        <div class="card">
          <h4>Skill Balance</h4>
          <canvas id="radarChart"></canvas>
        </div>

        <div class="card">
          <h4>üß† Concept Heatmap</h4>
          <div id="heatmap" class="heatmap-container"></div>
          <div class="missed-box">
            <strong>üîç Missed Keywords:</strong><br>
            <span id="missedKeywords" style="opacity:0.8;">None</span>
          </div>
        </div>

        <div class="card" style="grid-column: span 2; border-left: 5px solid #667eea; display: flex; align-items: center; gap: 20px;">
             <div style="font-size: 2.5rem;">üéØ</div>
             <div>
                <div style="font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.7;">Recommended Next Step</div>
                <div id="focusTitle" style="font-weight: 700; font-size: 1.2rem; color: #667eea; margin-bottom: 5px;">Computing...</div>
                <div id="focusDesc" style="font-size: 0.9rem; opacity: 0.9;">Analyzing your performance data...</div>
             </div>
        </div>
      </div>
    </div>

  </div>

<script>
const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
recognition.lang = "en-US";
let chartInstance = null;
let timerInterval = null;

// ==========================================
// üîä MALE VOICE ENGINE
// ==========================================
let voices = [];
function loadVoices() {
    voices = window.speechSynthesis.getVoices();
}
loadVoices();
if (window.speechSynthesis.onvoiceschanged !== undefined) {
    window.speechSynthesis.onvoiceschanged = loadVoices;
}

function speakText(text) {
    if(!text) return;
    
    // 1. Clear previous speech
    window.speechSynthesis.cancel();

    // 2. Create the utterance
    const utterance = new SpeechSynthesisUtterance(text);
    
    // 3. üîç HUNT FOR A MALE VOICE
    if(voices.length === 0) loadVoices(); 
    
    const maleVoice = voices.find(v => 
        v.name.toLowerCase().includes('male') ||   // Most Android/Chrome voices have "Male" in name
        v.name.includes('David') ||                // Windows Default (Microsoft David)
        v.name.includes('Daniel') ||               // Mac Default
        v.name.includes('Google US English')       // Fallback for some Androids
    );
    
    if (maleVoice) {
        utterance.voice = maleVoice;
    }

    // 4. Tweak Pitch/Rate for a more masculine tone
    utterance.rate = 1;
    utterance.pitch = 0.9; // Lower pitch = deeper voice

    // 5. Speak
    window.speechSynthesis.speak(utterance);
}


// --- DYNAMIC TIME LIMITS ---
const TIME_LIMITS = {
    "easy": 60,       
    "medium": 90,     
    "hard": 150,      
    "practical": 120  
};

function formatTime(seconds) {
    const m = Math.floor(seconds / 60);
    const s = seconds % 60;
    return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
}

// --- HELPER: Display Question with Badge & Timer ---
function displayBotQuestion(qObj) {
    if(!qObj) return;
    
    const diff = qObj.difficulty;
    const text = qObj.text;
    const time = TIME_LIMITS[diff] || 90;
    
    const badgeHtml = `<span class="diff-badge diff-${diff}">${diff}</span>`;
    
    const box = document.getElementById("chat-box");
    const div = document.createElement("div");
    div.className = "message bot";
    div.innerHTML = `${badgeHtml}<br>${text}`;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
    
    startTimer(time);
    
    // CALL THE NEW SPEECH FUNCTION
    speakText(text);
}

// --- CORE LOGIC ---
async function startInterview() {
    // üî• WAKE UP AUDIO ENGINE (Mobile Fix)
    // Mobile browsers require a user gesture to play audio. 
    // We play a silent snippet immediately on click.
    speakText(""); 

    document.getElementById("chat-box").innerHTML = "";
    document.getElementById("dashboard").style.display = "none";
    document.getElementById("status").innerText = "Generating questions...";
    
    const topic = document.getElementById("topicSelect").value;
    const length = document.getElementById("lengthSelect").value;
    
    try {
        const res = await fetch("/start_interview", {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ topic, length })
        });
        const data = await res.json();
        
        appendMessage("bot", data.reply);
        
        if(data.next_question) {
            setTimeout(() => displayBotQuestion(data.next_question), 1000);
        }
        
        document.getElementById("status").innerText = "Interview in Progress";
    } catch(e) {
        console.error(e);
        document.getElementById("status").innerText = "Connection Error";
    }
}

async function sendAnswer(text) {
    if(!text) return;
    appendMessage("user", text);
    document.getElementById("status").innerText = "Thinking...";
    clearInterval(timerInterval);
    
    try {
        const res = await fetch("/chat", {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: text })
        });
        const data = await res.json();
        
        if (data.finished) {
            appendMessage("bot", data.reply);
            document.getElementById("status").innerText = "Done. Click End.";
            document.getElementById("timer").innerText = "‚è± 00:00";
            document.getElementById("timer").style.color = "inherit";
            document.getElementById("timer").style.borderColor = "var(--glass-border)";
        } else {
            if(data.reply) appendMessage("bot", data.reply);
            if(data.next_question) displayBotQuestion(data.next_question);
            document.getElementById("status").innerText = "Your Turn";
        }
    } catch(e) {
        appendMessage("bot", "‚ö†Ô∏è Error connecting to AI.");
    }
}

function appendMessage(sender, text) {
    const box = document.getElementById("chat-box");
    const div = document.createElement("div");
    div.className = `message ${sender}`;
    div.innerText = text;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
    
    // Only speak if it's the bot
    if(sender === 'bot') {
        speakText(text);
    }
}

// --- TIMER FUNCTION ---
function startTimer(seconds) {
  clearInterval(timerInterval);
  let timeLeft = seconds;
  const timerEl = document.getElementById("timer");
  timerEl.innerText = "‚è± " + formatTime(timeLeft);
  timerEl.style.color = "inherit";
  timerEl.style.borderColor = "var(--glass-border)";
  
  timerInterval = setInterval(() => {
    timeLeft--;
    timerEl.innerText = "‚è± " + formatTime(timeLeft);
    
    if(timeLeft <= 30) {
        timerEl.style.color = "#ff5e62";
        timerEl.style.borderColor = "#ff5e62";
    }
    
    if (timeLeft <= 0) {
      clearInterval(timerInterval);
      document.getElementById("status").innerText = "Time's up!";
    }
  }, 1000);
}

recognition.onstart = () => { document.getElementById("status").innerText = "Listening..."; };
recognition.onresult = (e) => sendAnswer(e.results[0][0].transcript);
function startListening() { recognition.start(); }

function toggleTheme() {
    document.body.classList.toggle('light');
}

async function endInterview() {
    clearInterval(timerInterval);
    document.querySelector(".btn-start").disabled = true;
    document.querySelector(".btn-end").disabled = true;

    const chatBox = document.getElementById("chat-box");
    const statusEl = document.getElementById("status");

    // 1. Create the Processing Message Bubble
    const processDiv = document.createElement("div");
    processDiv.className = "processing-box"; 
    // Initial state
    processDiv.innerHTML = `
        <span class="processing-icon">‚ö°</span>
        <div>
            <div style="font-weight:600; font-size:1rem;">Processing...</div>
            <div id="dynamic-text" style="font-size:0.85rem; opacity:0.8;">Analyzing answers...</div>
        </div>
    `;
    chatBox.appendChild(processDiv);
    chatBox.scrollTop = chatBox.scrollHeight;

    // 2. Start the Text Cycler (Runs in background)
    const phases = [
        "Analyzing answer quality...",
        "Generating insights...",
        "Checking technical accuracy...",
        "Finalizing report..."
    ];
    let phaseIndex = 0;
    
    // Change text every 1.5 seconds while waiting
    const textInterval = setInterval(() => {
        phaseIndex = (phaseIndex + 1) % phases.length;
        const textEl = document.getElementById("dynamic-text");
        if(textEl) textEl.innerText = phases[phaseIndex];
    }, 1500);

    try {
        // 3. The Actual Network Call
        statusEl.innerText = "Analyzing...";
        const res = await fetch("/analytics");
        const data = await res.json();
        
        // 4. Cleanup (Stop animation immediately when data arrives)
        clearInterval(textInterval);
        processDiv.remove(); // Remove the processing box
        statusEl.innerText = "Done";

        // 5. Show Dashboard
        document.getElementById("dashboard").style.display = "block";
        document.getElementById("hiringProb").innerText = data.hiring_probability + "%";

        // --- Render Radar Chart ---
        const ctx = document.getElementById('radarChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();

        const scoreData = data.scores || [data.hiring_probability, 75, 80, 70, 85];

        chartInstance = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['Technical Accuracy', 'Clarity', 'Completeness', 'Vocabulary', 'Practicality'],
                datasets: [{
                    label: 'Performance',
                    data: scoreData, 
                    backgroundColor: 'rgba(46, 204, 113, 0.4)', 
                    borderColor: '#2ecc71',                     
                    borderWidth: 2,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#2ecc71'
                }]
            },
            options: {
                responsive: true,
                scales: {
                    r: {
                        angleLines: { color: 'rgba(255, 255, 255, 0.1)' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        pointLabels: { color: '#fff', font: { size: 11 } }, 
                        ticks: { display: false, backdropColor: 'transparent' },
                        suggestedMin: 20, suggestedMax: 100
                    }
                },
                plugins: { legend: { display: false } }
            }
        });

        // --- Render Heatmap ---
        const heatmapDiv = document.getElementById("heatmap");
        heatmapDiv.innerHTML = "";
        
        if(data.strong_concepts) {
            data.strong_concepts.forEach(c => heatmapDiv.innerHTML += `<div class="tag strong">‚úÖ ${c}</div>`);
        }
        if(data.weak_concepts) {
            data.weak_concepts.forEach(c => heatmapDiv.innerHTML += `<div class="tag weak">‚ö†Ô∏è ${c}</div>`);
        }

        // --- Render Keywords ---
        if(data.missed_keywords && data.missed_keywords.length > 0) {
            document.getElementById("missedKeywords").innerText = data.missed_keywords.join(", ");
        } else {
            document.getElementById("missedKeywords").innerText = "None! Great vocabulary.";
        }
        
        // --- Render Next Step ---
        const focusTitle = document.getElementById("focusTitle");
        const focusDesc = document.getElementById("focusDesc");
        if(data.weak_concepts && data.weak_concepts.length > 0) {
            focusTitle.innerText = "Review " + data.weak_concepts[0];
            focusDesc.innerText = "This was a weak point. Check documentation or practice more problems on this topic.";
        } else {
            focusTitle.innerText = "Advance to Next Level";
            focusDesc.innerText = "Your basics are strong! Try increasing the difficulty.";
        }

    } catch(e) {
        clearInterval(textInterval);
        console.error(e);
        statusEl.innerText = "Error";
        // Show error in the box instead of removing it
        const textEl = document.getElementById("dynamic-text");
        if(textEl) {
            textEl.innerText = "Failed to connect to server.";
            textEl.style.color = "#ff5e62";
        }
    }
}


window.addEventListener('load', checkDeviceSupport);
window.addEventListener('resize', checkDeviceSupport);
</script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  // --- PASTE YOUR FULL CONFIG HERE ---
  // (Copy this part from the Firebase website "Script tag" option)
  const firebaseConfig = {
    apiKey: "AIzaSyAfAGAKDMyg_0-HSKxtnyi5uKTfbnvAPjM",
    authDomain: "ai-interviewer-39709.firebaseapp.com",
    projectId: "ai-interviewer-39709",
    storageBucket: "ai-interviewer-39709.appspot.com",
    messagingSenderId: "367207604646",
    appId: "PASTE_YOUR_FULL_APP_ID_HERE" 
  };

  // Initialize
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  // Login Function
  window.handleLogin = () => {
    signInWithPopup(auth, provider)
      .then((result) => {
        console.log("Logged in:", result.user.displayName);
      }).catch((error) => {
        console.error("Login Error:", error);
        alert("Login failed: " + error.message);
      });
  };

  // Logout Function
  window.handleLogout = () => {
    signOut(auth).then(() => location.reload());
  }

  // UI Updates
  onAuthStateChanged(auth, (user) => {
    const loginBtn = document.getElementById("login-btn");
    const userProfile = document.getElementById("user-profile");
    
    if (user) {
        if(loginBtn) loginBtn.style.display = "none";
        if(userProfile) {
            userProfile.style.display = "flex";
            document.getElementById("user-img").src = user.photoURL;
            document.getElementById("user-name").innerText = user.displayName.split(" ")[0];
        }
    } else {
        if(loginBtn) loginBtn.style.display = "block";
        if(userProfile) userProfile.style.display = "none";
    }
  });
</script>
</body>
</html>
