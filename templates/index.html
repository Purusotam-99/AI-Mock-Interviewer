<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Mock Interviewer Pro</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --primary-grad: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --glass-bg: rgba(255, 255, 255, 0.1);
      --glass-border: 1px solid rgba(255, 255, 255, 0.2);
      --text-color: #ffffff;
      --bubble-user: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
      --bubble-bot: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    body.light {
      --primary-grad: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      --glass-bg: rgba(0, 0, 0, 0.05);
      --glass-border: 1px solid rgba(0, 0, 0, 0.1);
      --text-color: #333333;
    }

    * { box-sizing: border-box; transition: all 0.3s ease; }

    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: #0f2027; 
      background: linear-gradient(to right, #2c5364, #203a43, #0f2027); 
      color: var(--text-color);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    body.light { background: #e0eafc; }

    .app-container {
      width: 100%;
      max-width: 1100px;
      background: var(--glass-bg);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-radius: 24px;
      border: var(--glass-border);
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
      padding: 30px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    /* --- HEADER (MATCHING YOUR IMAGE) --- */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      border-bottom: var(--glass-border);
      padding-bottom: 20px;
    }

    .title-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-icon {
      font-size: 2rem;
    }

    h1 {
      margin: 0;
      font-weight: 700;
      font-size: 1.8rem;
      letter-spacing: 0.5px;
      line-height: 1;
    }

    .pro-badge {
      font-size: 0.5em;
      font-weight: 700;
      text-transform: uppercase;
      opacity: 0.6; /* The greyish look */
      margin-left: 5px;
      vertical-align: middle;
      color: inherit;
    }

    .controls { display: flex; gap: 10px; }

    select {
      background: rgba(0, 0, 0, 0.3);
      color: white;
      border: 1px solid rgba(255,255,255,0.2);
      padding: 10px 15px;
      border-radius: 12px;
      outline: none;
      font-family: inherit;
      cursor: pointer;
    }
    body.light select { background: white; color: #333; border: 1px solid #ccc; }

    /* --- CHAT BOX --- */
    #chat-box {
      flex: 1;
      height: 400px;
      overflow-y: auto;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 20px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .message {
      max-width: 80%;
      padding: 12px 18px;
      border-radius: 18px;
      line-height: 1.5;
      position: relative;
      animation: fadeIn 0.4s ease;
      font-size: 0.95rem;
    }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .message.bot {
      background: var(--bubble-bot);
      color: #004e92;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
      font-weight: 500;
    }

    .message.user {
      background: var(--bubble-user);
      color: #0f3443;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
      font-weight: 500;
    }

    /* --- ACTION BAR --- */
    .action-bar {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-top: 10px;
    }

    button {
      padding: 12px 24px;
      border: none;
      border-radius: 14px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 0.85rem;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .btn-start { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .btn-speak { background: linear-gradient(135deg, #ff9966 0%, #ff5e62 100%); color: white; }
    .btn-end { background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); color: white; }
    .btn-theme { background: rgba(255,255,255,0.1); color: inherit; border: 1px solid rgba(255,255,255,0.2); }

    button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
    button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    #status { font-size: 0.9rem; opacity: 0.7; margin-left: auto; font-style: italic; }

    /* --- DASHBOARD --- */
    #dashboard {
      display: none;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 24px;
      padding: 25px;
      margin-top: 20px;
      animation: fadeIn 0.6s ease;
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 25px;
    }

    .card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      padding: 20px;
      border: 1px solid rgba(255,255,255,0.05);
    }

    h3, h4 { margin: 0 0 15px 0; font-weight: 600; }

    /* Heatmap Styles */
    .heatmap-container { display: flex; flex-wrap: wrap; gap: 8px; }
    .tag {
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 0.8rem;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    .tag.strong { background: rgba(67, 233, 123, 0.2); color: #43e97b; border: 1px solid #43e97b; }
    .tag.weak { background: rgba(255, 94, 98, 0.2); color: #ff5e62; border: 1px solid #ff5e62; }

    .missed-box {
      margin-top: 15px;
      padding: 15px;
      background: rgba(255, 94, 98, 0.1);
      border-radius: 12px;
      border-left: 4px solid #ff5e62;
      font-size: 0.9rem;
      color: #ffcccb;
    }

    /* Fixed Hiring Probability Badge */
    .prob-badge {
      font-size: 2rem;
      font-weight: 700;
      background: linear-gradient(to right, #43e97b, #38f9d7);
      -webkit-background-clip: text;
      background-clip: text; 
      -webkit-text-fill-color: transparent;
      color: transparent;
    }

    @media (max-width: 768px) {
      .dashboard-grid { grid-template-columns: 1fr; }
      .controls { width: 100%; justify-content: space-between; margin-top: 10px; }
      select { width: 48%; }
      .card[style*="grid-column: span 2"] { grid-column: span 1 !important; }
    }
  </style>
</head>
<body>

  <div class="app-container">
    <header>
      <div class="title-group">
          <div class="logo-icon">üéôÔ∏è</div>
          <h1>AI Interviewer<span class="pro-badge">PRO</span></h1>
      </div>

      <div class="controls">
        <select id="lengthSelect">
          <option value="5">‚ö° Quick (5)</option>
          <option value="8" selected>üéØ Standard (8)</option>
          <option value="12">üî• Deep (12)</option>
        </select>
        <select id="topicSelect">
          <option value="javascript">JavaScript</option>
          <option value="dsa">DSA</option>
          <option value="sql">SQL</option>
          <option value="python">Python</option>
        </select>
      </div>
    </header>

    <div id="chat-box">
      <div style="text-align:center; color:rgba(255,255,255,0.5); margin-top:150px;">
        Select a topic and length above,<br>then click <strong>Start Interview</strong>.
      </div>
    </div>

    <div class="action-bar">
      <button class="btn-start" onclick="startInterview()">Start Interview</button>
      <button class="btn-speak" onclick="startListening()">üéô Speak Answer</button>
      <button class="btn-end" onclick="endInterview()">End & Analyze</button>
      <button class="btn-theme" onclick="toggleTheme()">üåì</button>
      <span id="status">Ready</span>
    </div>

    <div id="dashboard">
      <div class="dashboard-header">
        <div>
          <h3>Interview Analysis</h3>
          <span style="opacity:0.7">Performance Report</span>
        </div>
        <div style="text-align:right;">
          <div style="font-size:0.8rem; opacity:0.7;">Hiring Probability</div>
          <div class="prob-badge" id="hiringProb">0%</div>
        </div>
      </div>

      <div class="dashboard-grid">
        <div class="card">
          <h4>Skill Balance</h4>
          <canvas id="radarChart"></canvas>
        </div>

        <div class="card">
          <h4>üß† Concept Heatmap</h4>
          <div id="heatmap" class="heatmap-container"></div>
          <div class="missed-box">
            <strong>üîç Missed Keywords:</strong><br>
            <span id="missedKeywords" style="opacity:0.8;">None</span>
          </div>
        </div>

        <div class="card" style="grid-column: span 2; border-left: 5px solid #667eea; display: flex; align-items: center; gap: 20px;">
             <div style="font-size: 2.5rem;">üéØ</div>
             <div>
                <div style="font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.7;">Recommended Next Step</div>
                <div id="focusTitle" style="font-weight: 700; font-size: 1.2rem; color: #667eea; margin-bottom: 5px;">Computing...</div>
                <div id="focusDesc" style="font-size: 0.9rem; opacity: 0.9;">Analyzing your performance data...</div>
             </div>
        </div>
      </div>
    </div>

  </div>

<script>
const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
recognition.lang = "en-US";
let chartInstance = null;

async function startInterview() {
    document.getElementById("chat-box").innerHTML = "";
    document.getElementById("dashboard").style.display = "none";
    document.getElementById("status").innerText = "Generating questions...";
    
    const topic = document.getElementById("topicSelect").value;
    const length = document.getElementById("lengthSelect").value;
    
    try {
        const res = await fetch("/start_interview", {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ topic, length })
        });
        const data = await res.json();
        appendMessage("bot", data.reply);
        document.getElementById("status").innerText = "Interview in Progress";
    } catch(e) {
        console.error(e);
        document.getElementById("status").innerText = "Connection Error";
    }
}

async function sendAnswer(text) {
    if(!text) return;
    appendMessage("user", text);
    document.getElementById("status").innerText = "Thinking...";
    
    try {
        const res = await fetch("/chat", {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: text })
        });
        const data = await res.json();
        if(data.reply) appendMessage("bot", data.reply);
        document.getElementById("status").innerText = "Your Turn";
    } catch(e) {
        appendMessage("bot", "‚ö†Ô∏è Error connecting to AI.");
    }
}

function appendMessage(sender, text) {
    const box = document.getElementById("chat-box");
    const div = document.createElement("div");
    div.className = `message ${sender}`;
    div.innerText = text;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
    
    if(sender === 'bot') {
        let u = new SpeechSynthesisUtterance(text);
        window.speechSynthesis.speak(u);
    }
}

recognition.onstart = () => { document.getElementById("status").innerText = "Listening..."; };
recognition.onresult = (e) => sendAnswer(e.results[0][0].transcript);
function startListening() { recognition.start(); }

// --- THE KILLER UX: PROGRESSIVE REVEAL + NEXT FOCUS ---
async function endInterview() {
    // 1. Disable buttons
    document.querySelector(".btn-start").disabled = true;
    document.querySelector(".btn-end").disabled = true;
    document.getElementById("status").innerText = "Processing...";
    
    // 2. Progressive Logs Animation
    const steps = [
        "Analyzing answer clarity...", 
        "Extracting key concepts...", 
        "Generating concept heatmap...", 
        "Computing hiring probability..."
    ];
    let stepIndex = 0;
    
    const loaderInterval = setInterval(() => {
        if(stepIndex < steps.length) {
             const box = document.getElementById("chat-box");
             const div = document.createElement("div");
             div.className = "message"; 
             div.style.background = "rgba(0, 0, 0, 0.2)"; 
             div.style.color = "#ccc";
             div.style.fontFamily = "'Courier New', monospace";
             div.style.fontSize = "0.85rem";
             div.style.padding = "8px 12px";
             div.style.marginBottom = "5px";
             div.style.width = "fit-content";
             div.innerHTML = `‚öôÔ∏è ${steps[stepIndex]} <span style="color:#43e97b; font-weight:bold; margin-left:10px;">‚úì</span>`;
             box.appendChild(div);
             box.scrollTop = box.scrollHeight;
             stepIndex++;
        }
    }, 800);

    try {
        const res = await fetch("/analytics");
        const data = await res.json();
        
        clearInterval(loaderInterval);
        document.getElementById("status").innerText = "Analysis Complete";

        // 3. Populate Dashboard
        document.getElementById("dashboard").style.display = "block";
        document.getElementById("hiringProb").innerText = data.hiring_probability + "%";

        // Heatmap
        const heatmapDiv = document.getElementById("heatmap");
        heatmapDiv.innerHTML = "";
        if(data.strong_concepts) data.strong_concepts.forEach(c => heatmapDiv.innerHTML += `<div class="tag strong">‚úÖ ${c}</div>`);
        if(data.weak_concepts) data.weak_concepts.forEach(c => heatmapDiv.innerHTML += `<div class="tag weak">‚ö†Ô∏è ${c}</div>`);

        // Missed Keywords
        if(data.missed_keywords && data.missed_keywords.length > 0) {
            document.getElementById("missedKeywords").innerText = data.missed_keywords.join(", ");
        } else {
            document.getElementById("missedKeywords").innerText = "None! Great vocabulary.";
        }
        
        // --- NEXT FOCUS CARD LOGIC ---
        const focusTitle = document.getElementById("focusTitle");
        const focusDesc = document.getElementById("focusDesc");
        if(data.weak_concepts && data.weak_concepts.length > 0) {
            const topWeakness = data.weak_concepts[0]; 
            focusTitle.innerText = `Master "${topWeakness}"`;
            focusDesc.innerHTML = `You struggled with <strong>${topWeakness}</strong>. We recommend studying this before retrying.`;
        } else {
             focusTitle.innerText = "Level Up Difficulty";
             focusDesc.innerText = "Perfect session! Try increasing the difficulty to 'Deep' mode.";
        }

        // Radar Chart
        const ctx = document.getElementById("radarChart").getContext('2d');
        if(chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['Technical Accuracy', 'Clarity', 'Completeness', 'Vocabulary', 'Practicality'],
                datasets: [{
                    label: 'Candidate Profile',
                    data: [
                        data.average_score, 
                        data.average_score + 1, 
                        10 - (data.missed_keywords ? data.missed_keywords.length : 0), 
                        8, 
                        data.hiring_probability / 10
                    ],
                    backgroundColor: 'rgba(67, 233, 123, 0.2)',
                    borderColor: '#43e97b',
                    pointBackgroundColor: '#fff'
                }]
            },
            options: {
                scales: {
                    r: {
                        angleLines: { color: 'rgba(255, 255, 255, 0.1)' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        pointLabels: { color: 'rgba(255, 255, 255, 0.7)', font: { size: 12 } },
                        ticks: { display: false, backdropColor: 'transparent' },
                        min: 0, max: 10
                    }
                },
                plugins: { legend: { display: false } }
            }
        });
        
        // Auto-scroll logic
        setTimeout(() => {
            document.getElementById("dashboard").scrollIntoView({ behavior: 'smooth' });
            document.querySelector(".btn-start").disabled = false;
            document.querySelector(".btn-end").disabled = false;
        }, 500);

    } catch (err) {
        clearInterval(loaderInterval);
        console.error(err);
        alert("Failed to generate report.");
    }
}

function toggleTheme() {
    document.body.classList.toggle("light");
}
</script>
</body>
</html>
