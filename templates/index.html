<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Mock Interviewer</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Poppins", sans-serif;
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      color: #fff;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: background 0.4s;
    }

    body.light {
      background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
      color: #000;
    }

    .app-container {
      width: 95%;
      max-width: 1000px;
      background: rgba(255,255,255,0.08);
      backdrop-filter: blur(12px);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.4);
      padding: 20px;
      display: flex;
      flex-direction: column;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    header h1 { margin: 0; font-size: 1.5rem; }

    .controls select {
      padding: 8px 10px;
      border-radius: 10px;
      border: none;
      outline: none;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 10px 0;
    }

    #timer { font-weight: bold; font-size: 1.1rem; }

    #chat-box {
      flex: 1;
      height: 400px;
      background: rgba(0,0,0,0.25);
      border-radius: 15px;
      padding: 15px;
      overflow-y: auto;
      margin-bottom: 10px;
    }

    .message {
      max-width: 75%;
      padding: 10px 14px;
      border-radius: 14px;
      margin: 8px 0;
      line-height: 1.4;
      position: relative;
    }

    .bot {
      background: linear-gradient(135deg, #4facfe, #00f2fe);
      color: #000;
      align-self: flex-start;
      margin-right: auto;
    }

    .user {
      background: linear-gradient(135deg, #43e97b, #38f9d7);
      color: #000;
      align-self: flex-end;
      margin-left: auto;
      text-align: right;
    }

    .feedback-box {
      font-size: 0.85rem;
      background: rgba(0,0,0,0.1);
      margin-top: 5px;
      padding: 5px;
      border-radius: 6px;
      border-left: 3px solid #ff5e62;
    }

    .score-badge {
      display: inline-block;
      background: #222;
      color: #fff;
      font-size: 0.75rem;
      padding: 2px 6px;
      border-radius: 4px;
      margin-top: 5px;
    }

    .progress-container {
      width: 100%;
      height: 6px;
      background: rgba(255,255,255,0.15);
      border-radius: 10px;
      overflow: hidden;
      margin: 10px 0;
    }

    .progress-bar {
      width: 0%;
      height: 100%;
      background: linear-gradient(135deg, #43e97b, #38f9d7);
      transition: width 0.4s;
    }

    button {
      border: none;
      border-radius: 12px;
      padding: 8px 14px;
      cursor: pointer;
      background: linear-gradient(135deg, #ff9966, #ff5e62);
      color: #000;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      font-weight: 600;
    }

    button.secondary {
      background: linear-gradient(135deg, #36d1dc, #5b86e5);
    }

    #status {
      font-size: 0.85rem;
      color: #e0e0e0;
      margin-left: 10px;
    }

    /* CSS for both Dashboard and Growth Tracker */
    #dashboard, #growthBox {
      display: none;
      margin-top: 15px;
      background: rgba(0,0,0,0.2);
      padding: 15px;
      border-radius: 12px;
    }
  </style>
</head>

<body>
  <div class="app-container">

    <header>
      <h1>üé§ AI Mock Interviewer</h1>
      <div class="controls">
        <select id="roleSelect">
          <option value="frontend">Frontend</option>
          <option value="backend">Backend</option>
          <option value="fullstack">Full Stack</option>
          <option value="data">Data Scientist</option>
          <option value="hr">HR</option>
        </select>

        <select id="difficultySelect">
          <option value="easy">Easy</option>
          <option value="medium">Medium</option>
          <option value="hard">Hard</option>
        </select>

        <select id="topicSelect">
          <option value="javascript">JavaScript</option>
          <option value="ds">Data Structures</option>
          <option value="system">System Design</option>
          <option value="sql">SQL</option>
          <option value="hr">General</option>
        </select>
      </div>
    </header>

    <div class="top-bar">
      <button class="secondary" onclick="toggleTheme()">üåì Theme</button>
      <div id="timer">‚è± 02:00</div>
    </div>

    <div class="progress-container">
      <div id="progress-bar" class="progress-bar"></div>
    </div>

    <div id="chat-box"></div>

    <div style="margin-top: 10px;">
      <button onclick="startInterview()">Start</button>
      <button class="secondary" onclick="startListening()">üéô Speak</button>
      <button class="secondary" onclick="endInterview()">End</button>
      <span id="status">Click Start</span>
    </div>

    <div id="dashboard">
      <h3>üìä Performance Dashboard</h3>
      <p>Average Score: <span id="avgScore">0</span>/10</p>
      <p>Total Questions: <span id="totalQ">0</span></p>
      <p>Rating: <span id="rating">-</span></p>
      <p>Hiring Probability: <span id="hiringProb">0</span>%</p>
      <canvas id="scoreChart" height="100"></canvas>
    </div>

    <div id="growthBox">
        <h3>üìà Growth Tracker (History)</h3>
        <canvas id="growthChart" height="100"></canvas>
        <button onclick="clearHistory()" style="margin-top:10px; background:#444; font-size:0.8rem;">Reset History</button>
    </div>

  </div>

<script>
let questionCount = 0;
let timeLeft = 120; // 2 Minutes
let timerInterval = null;
let chartInstance = null;
let growthChart = null;

// --- 1. Load History from Browser Memory ---
let sessionHistory = JSON.parse(localStorage.getItem("mockInterviewHistory")) || [];

// Check on page load if we have history to show
window.onload = function() {
    if(sessionHistory.length > 0) {
        document.getElementById("growthBox").style.display = "block";
        renderGrowthTracker(sessionHistory);
    }
};

const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
const recognition = new SpeechRecognition();
recognition.lang = "en-US";

function formatTime(seconds) {
    const m = Math.floor(seconds / 60);
    const s = seconds % 60;
    return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
}

function appendMessage(sender, text, feedback = null, score = null) {
  const box = document.getElementById("chat-box");
  const div = document.createElement("div");
  div.className = "message " + sender;

  let content = `<div>${text}</div>`;

  if (sender === "bot" && score !== null) {
    content += `<div class="score-badge">üìù Score: ${score}/10</div>`;
  }
  if (sender === "bot" && feedback) {
    content += `<div class="feedback-box">üí° ${feedback}</div>`;
  }

  div.innerHTML = content;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;

  if (sender === "bot") {
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.rate = 1.0;
    const voices = speechSynthesis.getVoices();
    const preferred = voices.find(v => v.lang.includes("en"));
    if (preferred) utterance.voice = preferred;
    window.speechSynthesis.speak(utterance);
  }
}

function updateProgress() {
  const percent = Math.min((questionCount / 10) * 100, 100);
  document.getElementById("progress-bar").style.width = percent + "%";
}

function startTimer() {
  clearInterval(timerInterval);
  timeLeft = 120; 
  document.getElementById("timer").innerText = "‚è± " + formatTime(timeLeft);
  
  timerInterval = setInterval(() => {
    timeLeft--;
    document.getElementById("timer").innerText = "‚è± " + formatTime(timeLeft);
    if (timeLeft <= 0) {
      clearInterval(timerInterval);
      document.getElementById("status").innerText = "Time's up! Speak now.";
    }
  }, 1000);
}

async function startInterview() {
  questionCount = 0;
  updateProgress();
  document.getElementById("chat-box").innerHTML = "";
  document.getElementById("dashboard").style.display = "none";
  // Keep growth box visible if history exists
  
  const role = document.getElementById("roleSelect").value;
  const difficulty = document.getElementById("difficultySelect").value;
  const topic = document.getElementById("topicSelect").value;

  document.getElementById("status").innerText = "Connecting...";

  try {
    const res = await fetch("/start_interview", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ role, difficulty, topic })
    });

    const data = await res.json();
    appendMessage("bot", data.reply || data.response); 
    startTimer();
    document.getElementById("status").innerText = "Interview Started";
  } catch (err) {
    console.error(err);
    document.getElementById("status").innerText = "Error starting interview.";
  }
}

async function sendAnswer(text) {
  if(!text) return;
  
  appendMessage("user", text);
  document.getElementById("status").innerText = "Analyzing...";

  try {
    const res = await fetch("/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: text })
    });

    const data = await res.json();
    appendMessage("bot", data.reply, data.feedback, data.score);

    questionCount++;
    updateProgress();
    startTimer();
    document.getElementById("status").innerText = "Your turn";

  } catch (err) {
    console.error(err);
    appendMessage("bot", "Error connecting to server.");
  }
}

recognition.onstart = () => { document.getElementById("status").innerText = "Listening..."; };
recognition.onend = () => { document.getElementById("status").innerText = "Processing..."; };
recognition.onresult = (e) => {
    const transcript = e.results[0][0].transcript;
    sendAnswer(transcript);
};

function startListening() { 
    try { recognition.start(); } catch(e) { console.log("Mic already active"); }
}

async function endInterview() {
  clearInterval(timerInterval);
  document.getElementById("status").innerText = "Fetching results...";
  
  const res = await fetch("/analytics");
  const data = await res.json();
  
  if (data.error) {
    alert("No data to show yet!");
    return;
  }

  // --- 2. Save New Data to Browser Memory ---
  const newSession = {
      date: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
      score: data.average_score,
      hiring_prob: data.hiring_probability
  };
  
  sessionHistory.push(newSession);
  localStorage.setItem("mockInterviewHistory", JSON.stringify(sessionHistory));
  // ------------------------------------------

  document.getElementById("dashboard").style.display = "block";
  document.getElementById("growthBox").style.display = "block";

  document.getElementById("chat-box").innerHTML += `<div style="text-align:center; padding:10px;">--- Interview Ended ---</div>`;

  document.getElementById("avgScore").innerText = data.average_score;
  document.getElementById("totalQ").innerText = data.total_questions;
  document.getElementById("rating").innerText = data.rating;
  document.getElementById("hiringProb").innerText = data.hiring_probability;

  renderScoreChart(data.details.map(d => d.score));
  renderGrowthTracker(sessionHistory);
}

function renderScoreChart(scores) {
  const ctx = document.getElementById("scoreChart").getContext("2d");
  if (chartInstance) chartInstance.destroy();

  chartInstance = new Chart(ctx, {
    type: "line",
    data: {
      labels: scores.map((_, i) => "Q" + (i + 1)),
      datasets: [{ 
          label: "Score Trend", 
          data: scores, 
          borderColor: "#43e97b",
          backgroundColor: "rgba(67, 233, 123, 0.2)",
          fill: true,
          tension: 0.4 
      }]
    },
    options: { 
        scales: { y: { min: 0, max: 10, grid: { color: "rgba(255,255,255,0.1)" } }, x: { grid: { display: false } } },
        plugins: { legend: { labels: { color: 'white' } } }
    }
  });
}

// --- 3. Render Growth Chart ---
function renderGrowthTracker(historyData) {
  const ctx = document.getElementById("growthChart").getContext("2d");
  if (growthChart) growthChart.destroy();

  growthChart = new Chart(ctx, {
    type: "line",
    data: {
      // Use Session number as label
      labels: historyData.map((s, i) => "Session " + (i + 1)), 
      datasets: [
        { 
            label: "Avg Score", 
            data: historyData.map(s => s.score), 
            borderColor: "#36d1dc", 
            borderWidth: 2,
            tension: 0.3
        },
        { 
            label: "Hiring %", 
            data: historyData.map(s => s.hiring_prob / 10), // Scale down to match score graph (0-10)
            borderColor: "#ff9966", 
            borderWidth: 2,
            borderDash: [5, 5],
            tension: 0.3
        }
      ]
    },
    options: { 
        scales: { y: { min: 0, max: 10, grid: { color: "rgba(255,255,255,0.1)" } } },
        plugins: { legend: { labels: { color: 'white' } } }
    }
  });
}

function clearHistory() {
    if(confirm("Clear all interview history?")) {
        localStorage.removeItem("mockInterviewHistory");
        sessionHistory = [];
        document.getElementById("growthBox").style.display = "none";
    }
}

function toggleTheme() {
  document.body.classList.toggle("light");
}
</script>
</body>
</html>
